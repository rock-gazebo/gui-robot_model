#!/bin/bash

USAGE="Usage: $0 file1 file2 ...

This program will use osgconv to convert mesh files into a simplified binary representation using the program 'osgconv'.
The environment variable SIMPLIFY is used to control the level of simpification (corresponding to the --simplify parameter of 'osgconv'). By default SIMPIFY=1.0 is assumed.
If the envorinment variable SMOOTH is set to True

    SIMPLIFY     Argument must be a
                 normalized value for the resultant percentage
                 reduction.
                 Example: --simplify .5
                          will produce a 50% reduced model.
                          
    SMOOTH       Smooth the surface by regenerating surface normals on
                 all geometry nodes

Example: SIMPLIFY=0.5 SMOOTH=true $0 path/to/meshes/*.obj
"

#check if osgconv is installed
command -v osgconv >/dev/null 2>&1 || { 
    echo >&2 "The program 'osgconv' is required, but it's not installed."
    echo >&2 ""
    echo >&2 "On Ubuntu you can install it with the following command:"
    echo >&2 "   apt-get install openscenegraph"
    exit 1;
}

#Print help text if of argument is given
if [ $# == 0 ] ; then
    echo "$USAGE"
    exit 1;
fi

#Evaluate if simpification level was set
if [ -z "$SIMPLIFY" ];
then
    echo "SIMPLIFY not set."
    echo "Choosing COMPLEXITY REDUCTION: '1.0'"
    SIMPLIFY=1.0;
else
    echo "COMPLEXITY REDUCTION: '$SIMPLIFY'";
fi
OSGCONVARGS="--simplify $SIMPLIFY"

#Evaluate if SMOOTH has been defined
if [ "$SMOOTH" = true ]; 
then
    echo "SMOOTHING: Activated";
    OSGCONVARGS="$OSGCONVARGS --smooth"
else 
    echo "SMOOTHING: Deactivated";
fi

#Process files
for fullfile in "$@"
do

  case "$fullfile" in
    *.osgb)
      ;;
    *)
      echo ""
      echo "Processing $fullfile file to $fullfile.osgb"
      OSG_OPTIMIZER="INDEX_MESH STATIC_OBJECT_DETECTION VERTEX_POSTTRANSFORM" osgconv $OSGCONVARGS $fullfile $fullfile.osgb
      ;;
  esac
done

